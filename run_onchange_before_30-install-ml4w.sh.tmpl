#!/bin/bash

# -----------------------------------------------------------------------------
# RUN_ONCHANGE TRIGGER: Forces this script to run whenever the external ML4W
# Git repository's HEAD commit hash changes, ensuring immediate base updates.
# -----------------------------------------------------------------------------

# hash: {{ output "git" "-C" .ml4wDotfilesDir "rev-parse" "HEAD" | sha256sum }}

set -e

# --- Configuration ---
REPO_URL="https://github.com/mylinuxforwork/dotfiles.git"
INSTALL_DIR="{{ .ml4wDotfilesDir }}"
TARGET_DIR="$HOME/.config"
BACKUP_DIR="$HOME/.config_backup_$(date +%Y%m%d_%H%M%S)"

# --- Functions ---
log() { echo -e "\033[0;32m[ML4W]\033[0m $1"; }
warn() { echo -e "\033[0;33m[WARN]\033[0m $1"; }

# --- 1. Clone Repo ---
if [ -d "$INSTALL_DIR" ]; then
    log "Updating Repo..."
    git -C "$INSTALL_DIR" pull || warn "Git pull failed. Using existing files."
else
    log "Cloning Repo..."
    git clone "$REPO_URL" "$INSTALL_DIR"
fi

# --- 2. Link Configuration ---
REPO_CONFIG="$INSTALL_DIR/dotfiles/.config"

if [ ! -d "$REPO_CONFIG" ]; then
    echo "ERROR: Repo config not found at $REPO_CONFIG"
    exit 1
fi

mkdir -p "$TARGET_DIR"

log "Linking config resources..."

for repo_folder in "$REPO_CONFIG"/*; do
    name=$(basename "$repo_folder")
    target="$TARGET_DIR/$name"

    # CASE A: Target doesn't exist or is a symlink -> Link the whole folder
    if [ ! -e "$target" ] || [ -L "$target" ]; then
        # Update link if needed
        ln -sfn "$repo_folder" "$target"
        # log "Linked Folder: $name"
        
    # CASE B: Target is a real directory (Chezmoi created it) -> Merge files
    elif [ -d "$target" ]; then
        # log "Merging $name..."
        
        # Loop through files inside the repo folder and link them individually
        find "$repo_folder" -mindepth 1 -maxdepth 1 | while read repo_file; do
            filename=$(basename "$repo_file")
            target_file="$target/$filename"
            
            # Only link if the file doesn't exist (Preserve your Chezmoi overrides)
            # OR if it's already a symlink (Update it)
            if [ ! -e "$target_file" ] || [ -L "$target_file" ]; then
                ln -sf "$repo_file" "$target_file"
            else
                # If it's a real file, that means YOU defined it in Chezmoi.
                # We skip it so your version wins.
                true 
            fi
        done
        log "Merged Folder: $name"
    fi
done

# --- 3. Link Root Dotfiles (.zshrc, etc) ---
REPO_ROOT="$INSTALL_DIR/dotfiles"
for file in ".zshrc" ".bashrc" ".xinitrc" ".gtkrc-2.0"; do
    src="$REPO_ROOT/$file"
    target="$HOME/$file"
    ln -sf "$src" "$target"
done

# --- 4. Run ML4W Hook ---
HOOK="$INSTALL_DIR/hook.sh"
if [ -f "$HOOK" ]; then
    log "Running Post-Install Hook..."
    bash "$HOOK"
fi

log "Done."