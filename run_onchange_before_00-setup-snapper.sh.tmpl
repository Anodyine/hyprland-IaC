#!/bin/bash
set -e
# ---------------------------------------------------------------------------------
# Snapper & GRUB Btrfs Setup via Chezmoi
# ---------------------------------------------------------------------------------

# This hash forces the script to run if the installed packages list changes in the future
# packages_hash: {{ "snapper snap-pac grub-btrfs inotify-tools" | sha256sum }}

echo ">> [Chezmoi] Starting Arch Snapper & GRUB Setup..."

# 1. Install Packages (Idempotent)
echo ">> [Chezmoi] Ensuring packages..."
sudo pacman -S --needed --noconfirm snapper snap-pac grub-btrfs inotify-tools

# 2. Configure Snapper
echo ">> [Chezmoi] Configuring Snapper root layout..."

# Only run config creation if the config file is missing
if [ ! -f "/etc/snapper/configs/root" ]; then
    echo "   Config missing. preparing layout..."
    
    # Unmount if strictly necessary to recreate layout
    if mountpoint -q /.snapshots; then
        sudo umount /.snapshots
    fi

    # Remove directory to allow snapper to initialize
    if [ -d "/.snapshots" ]; then
        sudo rm -rf /.snapshots
    fi

    sudo snapper -c root create-config /
    
    # Fix the directory structure immediately after creation
    sudo rm -rf /.snapshots
    sudo mkdir -p /.snapshots
    sudo mount -a
else
    echo "   Snapper config already exists. Skipping init."
fi

# 3. Configure Retention & Permissions
echo ">> [Chezmoi] Applying retention policy..."
CONF="/etc/snapper/configs/root"
USER="{{ .chezmoi.username }}"  # <--- Chezmoi variable used here

echo "   Setting permissions for user: $USER"
sudo chmod a+rx /.snapshots
sudo chown :$USER /.snapshots

# Update config using sed (Idempotent replacements)
sudo sed -i "s/^ALLOW_USERS=\"\"/ALLOW_USERS=\"$USER\"/" $CONF
sudo sed -i 's/^TIMELINE_LIMIT_HOURLY=".*"/TIMELINE_LIMIT_HOURLY="5"/' $CONF
sudo sed -i 's/^TIMELINE_LIMIT_DAILY=".*"/TIMELINE_LIMIT_DAILY="5"/' $CONF
sudo sed -i 's/^TIMELINE_LIMIT_WEEKLY=".*"/TIMELINE_LIMIT_WEEKLY="0"/' $CONF
sudo sed -i 's/^TIMELINE_LIMIT_MONTHLY=".*"/TIMELINE_LIMIT_MONTHLY="0"/' $CONF
sudo sed -i 's/^TIMELINE_LIMIT_YEARLY=".*"/TIMELINE_LIMIT_YEARLY="0"/' $CONF
sudo sed -i 's/^NUMBER_LIMIT=".*"/NUMBER_LIMIT="10"/' $CONF

# 4. Enable OverlayFS (Critical for Read-Only Snapshots)
echo ">> [Chezmoi] Checking mkinitcpio hooks..."
MKINIT="/etc/mkinitcpio.conf"

if grep -q "grub-btrfs-overlayfs" "$MKINIT"; then
    echo "   Overlay hook already present."
else
    if grep -q "HOOKS=.*systemd" "$MKINIT"; then
        echo "WARNING: Systemd initramfs detected. grub-btrfs-overlayfs may not work."
    fi

    echo "   Adding grub-btrfs-overlayfs to HOOKS..."
    sudo sed -i 's/^HOOKS=(\(.*\))/HOOKS=(\1 grub-btrfs-overlayfs)/' "$MKINIT"
    
    echo "   Regenerating initramfs..."
    sudo mkinitcpio -P
fi

# 5. Enable Services
echo ">> [Chezmoi] Enabling services..."
# Ensure the grub-btrfs script is executable
if [ -f "/etc/grub.d/41_snapshots-btrfs" ]; then
    sudo chmod +x /etc/grub.d/41_snapshots-btrfs
fi
sudo systemctl enable --now grub-btrfsd

# 6. The Redirect Fix (Bootloader Stub)
echo ">> [Chezmoi] Checking Bootloader Stub..."
STUB_FILE="/boot/efi/grub/grub.cfg"

# Only run the heavy Grub Install if the stub file is missing
if [ ! -f "$STUB_FILE" ]; then
    echo "   Stub missing. Installing GRUB modules and creating stub..."
    
    sudo grub-install --target=x86_64-efi \
      --efi-directory=/boot/efi \
      --bootloader-id=GRUB \
      --modules="btrfs part_gpt part_msdos" \
      --recheck

    ROOT_UUID=$(findmnt -n -o UUID /)
    if [ -z "$ROOT_UUID" ]; then
        echo "ERROR: Could not detect Root UUID."
        exit 1
    fi

    sudo mkdir -p "$(dirname "$STUB_FILE")"
    
    sudo tee "$STUB_FILE" > /dev/null <<EOF
search --no-floppy --fs-uuid --set=root $ROOT_UUID
set prefix=(\$root)/@/boot/grub
configfile /@/boot/grub/grub.cfg
EOF
    echo "   Stub created."
else
    echo "   Stub already exists at $STUB_FILE. Skipping reinstall."
fi

# 7. Generate Real Config
echo ">> [Chezmoi] Regenerating main GRUB config..."
sudo grub-mkconfig -o /boot/grub/grub.cfg

echo ">> [Chezmoi] Snapshot setup complete."