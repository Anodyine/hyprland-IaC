#!/bin/bash

# ---------------------------------------------------------------------------------
# SDDM Autologin Configuration via Chezmoi
# ---------------------------------------------------------------------------------

# 1. Define the target file
TARGET_FILE="/etc/sddm.conf.d/autologin.conf"
TARGET_DIR=$(dirname "$TARGET_FILE")

# 2. Define the content dynamically
# We use a variable so we can hash it for chezmoi to detect changes
read -r -d '' CONFIG_CONTENT <<EOF
[Autologin]
User={{ .chezmoi.username }}
Session=hyprland
EOF

# 3. Hash check (Important for chezmoi)
# This comment tells chezmoi to re-run this script only if the content below changes
# config_hash: {{ $config_content := "[Autologin]\nUser=" | print .chezmoi.username "\nSession=hyprland" }}{{ $config_content | sha256sum }}

echo "Configuring SDDM Autologin for user: {{ .chezmoi.username }}"

# 4. Create the directory if it's missing
if [ ! -d "$TARGET_DIR" ]; then
    echo "Creating directory $TARGET_DIR..."
    sudo mkdir -p "$TARGET_DIR"
fi

# 5. Write the file safely using sudo
echo "$CONFIG_CONTENT" | sudo tee "$TARGET_FILE" > /dev/null

echo "SDDM autologin configured successfully."